---
title: "reburn-data-prep"
output: html_document
date: '2022-06-03'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(here)
library(sf)
library(readxl)
library(terra)

data_dir = readLines(here("data_dir.txt"), n=1)
source(here("scripts/convenience_functions.R"))

```

This script preps data for the CA reburn analysis

## Organize MTBS data

rasterize mtbs fire perims and add year
```{r}
#load mtbs data
mtbs_perims = vect(datadir("/raw-data/fire-perims/mtbs_perimeter_data/mtbs_perims_DD.shp")) #Mercator (EPSG: 4269?)
#add fire year
mtbs_perims$YEAR = as.numeric(substr(as.character(mtbs_perims$Ig_Date), 1,4)) 
crs(mtbs_perims) = 'epsg:4269'
# mtbs_yr = mtbs_perims[,"YEAR"] #thought maybe the issue was that YEAR was not the first variable?

#extract states of interest
#load state boundaries
states = vect(datadir("/raw-data/geography/cb_2018_us_state_20m/cb_2018_us_state_20m.shp"))
states = project(states, mtbs_perims)

#intersect states and mtbs perims - this is kind of slow
mtbs_states = intersect(mtbs_perims, states)

#extract just CA for initial analysis
# states = states[, "NAME"] #select name column
mtbs_ca = mtbs_states[mtbs_states$NAME == "California",]

# Rasterize mtbs for easy extraction.  
r = rast(mtbs_ca, resolution = 0.001, crs = 'epsg:4269') 
```

Extract most recent and second most recent fires
```{r}
#When two fires overlap, keep the year of the most recent and second most recent
mostrecent_fire = rasterize(mtbs_ca, r, field="YEAR", fun=max)

#function to extract second most recent fire 
second_recent_func = function(x) {
  max(x[x != max(x)])    
}

secondrecent_fire = rasterize(mtbs_ca,r, field="YEAR", fun=second_recent_func)

```

Bring in the important 2021/2022 fires
```{r}
## 
```

